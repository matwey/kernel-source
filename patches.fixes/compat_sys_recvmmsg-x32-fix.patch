From 7e1b38ca9813bc563eac679f7c24775cce80f913 Mon Sep 17 00:00:00 2001
From: PaX Team <pageexec@freemail.hu>
Date: Wed, 29 Jan 2014 17:03:27 +0100
Subject: compat_sys_recvmmsg X32 fix
References: bnc#860993 CVE-2014-0038
Patch-mainline: v3.14-rc1
Git-commit: 2def2ef2ae5f3990aabdbe8a755911902707d268

This addresses CVE-2014-0038.

Fixes: ee4fa23c4bfcc635d077a9633d405610de45bc70
Signed-off-by: PaX Team <pageexec@freemail.hu>
Acked-by: Borislav Petkov <bp@suse.de>
---
 net/compat.c | 19 +++++++++++--------
 1 file changed, 11 insertions(+), 8 deletions(-)

Index: linux-3.7-openSUSE-12.3/net/compat.c
===================================================================
--- linux-3.7-openSUSE-12.3.orig/net/compat.c
+++ linux-3.7-openSUSE-12.3/net/compat.c
@@ -769,22 +769,25 @@ asmlinkage long compat_sys_recvmmsg(int
 	int datagrams;
 	struct timespec ktspec;
 
-	if (COMPAT_USE_64BIT_TIME)
-		return __sys_recvmmsg(fd, (struct mmsghdr __user *)mmsg, vlen,
-				      flags | MSG_CMSG_COMPAT,
-				      (struct timespec *) timeout);
-
 	if (timeout == NULL)
 		return __sys_recvmmsg(fd, (struct mmsghdr __user *)mmsg, vlen,
 				      flags | MSG_CMSG_COMPAT, NULL);
 
-	if (get_compat_timespec(&ktspec, timeout))
+	if (COMPAT_USE_64BIT_TIME) {
+		if (copy_from_user(&ktspec, timeout, sizeof(ktspec)))
+			return -EFAULT;
+	} else if (get_compat_timespec(&ktspec, timeout))
 		return -EFAULT;
 
 	datagrams = __sys_recvmmsg(fd, (struct mmsghdr __user *)mmsg, vlen,
 				   flags | MSG_CMSG_COMPAT, &ktspec);
-	if (datagrams > 0 && put_compat_timespec(&ktspec, timeout))
-		datagrams = -EFAULT;
+	if (datagrams > 0) {
+		if (COMPAT_USE_64BIT_TIME) {
+			if (copy_to_user(timeout, &ktspec, sizeof(ktspec)))
+				datagrams = -EFAULT;
+		} else if (put_compat_timespec(&ktspec, timeout))
+			datagrams = -EFAULT;
+	}
 
 	return datagrams;
 }

