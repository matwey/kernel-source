From: Carey Underwood <carey@scaletech.ca>
Date: Mon, 4 Mar 2013 16:37:06 -0600
Patch-mainline: 3.12
Git-commit: d790155457a830d064d57e742521f114d3c38108
Subject: [PATCH] Btrfs: Release uuid_mutex for shrink during device
 delete

Device scanning waits on the uuid_mutex, which can result in a very long
wait if dev delete is shrinking the device.

Signed-off-by: Carey Underwood <cwillu@cwillu.com>
Reviewed-by: David Sterba <dsterba@suse.cz>
Signed-off-by: Josef Bacik <jbacik@fusionio.com>
Signed-off-by: Chris Mason <chris.mason@fusionio.com>
Signed-off-by: David Sterba <dsterba@suse.cz>
---
 fs/btrfs/volumes.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/btrfs/volumes.c
+++ b/fs/btrfs/volumes.c
@@ -1562,7 +1562,9 @@ int btrfs_rm_device(struct btrfs_root *r
 		clear_super = true;
 	}
 
+	mutex_unlock(&uuid_mutex);
 	ret = btrfs_shrink_device(device, 0);
+	mutex_lock(&uuid_mutex);
 	if (ret)
 		goto error_undo;
 
